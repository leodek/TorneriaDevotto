<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TORNERIA DEVOTTO</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            margin: 2rem;
        }

        h1 {
            color: #2c3e50;
            margin-top: 0;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .tabs {
            display: flex;
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .tab {
            padding: .5rem 1rem;
            border: 1px solid #ccc;
            border-bottom: none;
        }

        .tab.active {
            background: #eee;
            font-weight: bold;
        }

        .panel {
            display: none;
            border: 1px solid #ccc;
            padding: 1rem;
        }

        .panel.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            font-size: .9rem;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: .4rem;
            text-align: left;
        }

        thead {
            background: #f0f0f0;
        }

        .filtros {
            display: flex;
            flex-wrap: wrap;
            gap: .8rem;
            align-items: center;
            font-size: .9rem;
        }

        .filtros input,
        .filtros select {
            padding: .3rem .4rem;
        }

        #last-update {
            font-size: .85rem;
            color: #555;
        }

        button#btnRefresh {
            padding: .4rem 1rem;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="topbar">
        <h1>TORNERIA DEVOTTO</h1>
        <div>
            <button id="btnRefresh">🔄 Actualizar ahora</button>
            <span id="last-update"></span>
        </div>
    </div>

    <!-- PESTAÑAS -->
    <div class="tabs">
        <div class="tab active" data-target="panel-entrada">Entrada y Salida</div>
        <div class="tab" data-target="panel-ordenes">Órdenes de Trabajo</div>
    </div>

    <!-- PANEL 1 · ENTRADA Y SALIDA -->
    <div id="panel-entrada" class="panel active">
        <div class="filtros">
            Responsable: <input id="fResp" type="text" placeholder="Nombre">
            Desde: <input id="fDesde" type="date">
            Hasta: <input id="fHasta" type="date">
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Fecha</th>
                    <th>Hora Entrada</th>
                    <th>Hora Salida</th>
                    <th>Total Horas</th>
                </tr>
            </thead>
            <tbody id="entrada-container"></tbody>
        </table>
    </div>

    <!-- PANEL 2 · ÓRDENES DE TRABAJO -->
    <div id="panel-ordenes" class="panel">
        <div class="filtros" id="ordenes-filtros">
            <input data-key="nro_ot" placeholder="OT">
            <input data-key="cliente" placeholder="Cliente">
            <input data-key="trabajo" placeholder="Trabajo">
            <select data-key="estado">
                <option value="">Estado</option>
                <option>Programada</option>
                <option>En proceso</option>
                <option>Procesada</option>
            </select>
            <select data-key="prioridad">
                <option value="">Prioridad</option>
                <option>Alta</option>
                <option>Media</option>
                <option>Baja</option>
            </select>
            <input data-key="responsable" placeholder="Responsable">
            <input data-key="observaciones" placeholder="Observaciones">
            <input data-key="fecha_ingreso" type="date" title="Filtrar desde fecha ingreso">
        </div>

        <table>
            <thead>
                <tr>
                    <th>Nro OT</th>
                    <th>Cliente</th>
                    <th>Trabajo</th>
                    <th>Estado</th>
                    <th>Prioridad</th>
                    <th>Responsable</th>
                    <th>Observaciones</th>
                    <th>Fecha Ingreso</th>
                </tr>
            </thead>
            <tbody id="ordenes-container"></tbody>
        </table>
    </div>

    <!-- =========================  S C R I P T  ========================= -->
    <script>
        /*--------- pestañas ---------*/
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                document.getElementById(tab.dataset.target).classList.add('active');
            });
        });

        /*--------- utilidades ---------*/
        function toISO(dmy) {           // "31/07/2025" -> "2025-07-31"
            if (!dmy || !dmy.includes('/')) return dmy;
            const [d, m, y] = dmy.split('/');
            return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
        }
        function fmtDateTime(d = new Date()) {
            return d.toLocaleString('es-ES', { hour12: false });
        }
        function setLastUpdate() { document.getElementById('last-update').textContent = 'Última actualización: ' + fmtDateTime(); }

        /*--------- fetch helper (sin caché) ---------*/
        function cargarYGuardar(url, setter) {
            const nocache = url + '?t=' + Date.now();
            return fetch(nocache, { cache: 'no-store' })
                .then(r => r.json()).then(setter)
                .catch(err => console.error(url, err));
        }

        /*================ 1 · ENTRADA Y SALIDA =================*/
        let dataEntrada = [];
        const entradaTbody = document.getElementById('entrada-container');

        function renderEntrada(list) {
            entradaTbody.innerHTML = '';
            list.forEach(it => {
                const tr = document.createElement('tr');
                ['nombre', 'fecha', 'hora_entrada', 'hora_salida', 'total_horas'].forEach(k => {
                    const td = document.createElement('td'); td.textContent = it[k] ?? ''; tr.appendChild(td);
                });
                entradaTbody.appendChild(tr);
            });
        }

        function aplicarFiltrosEntrada() {
            const resp = document.getElementById('fResp').value.toLowerCase();
            const dDesde = document.getElementById('fDesde').value;
            const dHasta = document.getElementById('fHasta').value;
            const filtrado = dataEntrada.filter(it => {
                const iso = toISO(it.fecha);
                const okResp = resp === '' || (it.nombre ?? '').toLowerCase().includes(resp);
                const okDesde = !dDesde || iso >= dDesde;
                const okHasta = !dHasta || iso <= dHasta;
                return okResp && okDesde && okHasta;
            });
            renderEntrada(filtrado);
        }
        ['fResp', 'fDesde', 'fHasta'].forEach(id => {
            document.getElementById(id).addEventListener('input', aplicarFiltrosEntrada);
            document.getElementById(id).addEventListener('change', aplicarFiltrosEntrada);
        });

        /*================ 2 · ÓRDENES DE TRABAJO =================*/
        let dataOrdenes = [];
        const ordenesTbody = document.getElementById('ordenes-container');

        function renderOrdenes(list) {
            ordenesTbody.innerHTML = '';
            list.forEach(it => {
                const tr = document.createElement('tr');
                ['nro_ot', 'cliente', 'trabajo', 'estado', 'prioridad', 'responsable', 'observaciones', 'fecha_ingreso']
                    .forEach(k => {
                        const td = document.createElement('td'); td.textContent = it[k] ?? ''; tr.appendChild(td);
                    });
                ordenesTbody.appendChild(tr);
            });
        }

        function aplicarFiltrosOrdenes() {
            const filtros = {};
            document.querySelectorAll('#ordenes-filtros [data-key]').forEach(el => {
                filtros[el.dataset.key] = el.value.trim().toLowerCase();
            });
            const filtrado = dataOrdenes.filter(it => {
                return Object.entries(filtros).every(([k, val]) => {
                    if (!val) return true;
                    if (k === 'fecha_ingreso') return it[k] >= val;    // desde fecha
                    return (it[k] ?? '').toString().toLowerCase().includes(val);
                });
            });
            renderOrdenes(filtrado);
        }
        document.querySelectorAll('#ordenes-filtros input,#ordenes-filtros select')
            .forEach(el => el.addEventListener('input', aplicarFiltrosOrdenes));

        /*================ 3 · CARGA Y REFRESCO =================*/
        function cargarTodo() {
            Promise.all([
                cargarYGuardar('data/entrada_salida.json', d => { dataEntrada = d; aplicarFiltrosEntrada(); }),
                cargarYGuardar('data/ordenes_trabajo.json', d => { dataOrdenes = d; aplicarFiltrosOrdenes(); })
            ]).then(setLastUpdate);
        }
        const hoyISO = new Date().toISOString().split('T')[0];
        document.getElementById('fDesde').value = hoyISO;
        document.getElementById('fHasta').value = hoyISO;

        document.getElementById('btnRefresh').addEventListener('click', cargarTodo);

        cargarTodo();                     // inicial
        setInterval(cargarTodo, 60 * 1000); // cada minuto
    </script>
</body>

</html>